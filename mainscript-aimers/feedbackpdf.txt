const FOLDER_ID_PDF = "1QcrzzaobCLor1Twvyd3S5pb2B5fp0j1e"; // PDF Folder
const FOLDER_ID_DOCS = "114LTprcJz-R6CQ06K_ZMJ6qroDMOD2Wb"; // Daily Docs Folder
const SHEET_NAME = "Form Responses 1";

function generateTodayFeedbackPDF() {
  const sheet = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const lastRowIndex = data.length - 1;
  const lastRow = data[lastRowIndex];

  if (!lastRow[12] && lastRow[12] !== 0) return; 

  // 1. DATE & FILE NAME (UPDATED FORMAT)
  const rawDate = lastRow[0];
  const dateObj = (rawDate instanceof Date) ? rawDate : new Date(rawDate);
  const dateStr = Utilities.formatDate(dateObj, Session.getScriptTimeZone(), "yyyy-MM-dd");
  const fileName = `ğŸ“˜ NF_Lifestyle â€“ ${dateStr} Feedback`; // âœ… UPDATED FORMAT

  // 2. CHECK EXISTING
  const pdfFolder = DriveApp.getFolderById(FOLDER_ID_PDF);
  if (pdfFolder.getFilesByName(fileName).hasNext()) return;

  // 3. GET DOC CONTENT
  const docContent = getDailyDocContent(dateStr, sheet, lastRowIndex + 1);
  if (!docContent) return; 

  // 4. GET SHEET DATA
  const sheetData = extractSheetData(lastRow, data, lastRowIndex);

  // 5. GENERATE PROMPT
  const prompt = buildPrompt(sheetData, docContent);
  const aiResponse = getGroqResponse(prompt);

  if (!aiResponse || aiResponse.includes("âŒ")) {
    sheet.getRange(lastRowIndex + 1, 26).setValue("âŒ Groq Failed").setBackground("#ffd6d6");
    return;
  }

  // 6. CREATE PDF
  const htmlContent = buildStyledHTML(dateStr, aiResponse, sheetData);
  const blob = Utilities.newBlob(htmlContent, 'text/html', `${fileName}.html`);
  const pdf = blob.getAs('application/pdf').setName(fileName);

  pdfFolder.createFile(pdf);
  sheet.getRange(lastRowIndex + 1, 26).setValue("âœ… PDF Created").setBackground("#d0f0c0");
}

// ğŸ“„ GET DOC CONTENT
function getDailyDocContent(dateStr, sheet, rowIndex) {
  const folder = DriveApp.getFolderById(FOLDER_ID_DOCS);
  const files = folder.getFilesByName(`Plan for ${dateStr}`);
  
  if (!files.hasNext()) {
    Logger.log("No doc found for: Plan for " + dateStr);
    sheet.getRange(rowIndex, 13).setValue("âŒ No Doc Found").setBackground("#ffd6d6");
    return null;
  }
  const doc = DocumentApp.openById(files.next().getId());
  return doc.getBody().getText();
}

// ğŸ“Š EXTRACT DATA
function extractSheetData(row, allData, rowIndex) {
  const num = (i) => Number(row[i]) || 0;
  const str = (i) => String(row[i] || "â€”");

  const sessionStr = str(1); 
  const sessions = sessionStr.split('+').map(s => Number(s.trim()) || 0);

  const prevRow = rowIndex > 1 ? allData[rowIndex - 1] : null;
  const plannedToday = prevRow ? (Number(prevRow[6]) || 510) : 510;

  return {
    date: str(0),
    sessionString: sessionStr,
    sessionsArr: sessions,
    tasksDone: num(2),
    tasksPlanned: num(3),
    wastedTime: num(4),
    phoneTime: num(5),
    studyTimeEarned: num(12),
    plannedToday: plannedToday,
    xpRate: num(13),
    totalXP: num(14),
    level: num(15),
    streak: num(16),
    completionRate: plannedToday > 0 ? Math.round((num(12) / plannedToday) * 100) : 0
  };
}

// ğŸ”¥ PROMPT
function buildPrompt(d, docText) {
  return `
You are a fierce, legendary JEE mentor.
ANALYZE Pawan Washudev's day using his PERSONAL DIARY (from Docs) and SYSTEM STATS (from Sheets).

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“„ PAWAN'S WRITTEN DIARY & PLAN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${docText}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š SYSTEM REALITY (The Truth)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ **Study Time:** ${d.studyTimeEarned} mins (Target: ${d.plannedToday})
â€¢ **Tasks:** ${d.tasksDone} / ${d.tasksPlanned} Completed
â€¢ **XP Rate:** ${d.xpRate}x
â€¢ **Sessions:** [${d.sessionsArr.join(", ")}]
â€¢ **Wasted:** ${d.wastedTime} mins | **Phone:** ${d.phoneTime} mins
â€¢ **Level:** ${d.level} | **Streak:** ${d.streak}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MENTOR ANALYSIS REQUIRED (Max 800 words)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. **ğŸ”¥ DIARY VS REALITY CHECK**
   - Compare his diary words vs. the System Stats.
   - He completed ${d.tasksDone} out of ${d.tasksPlanned} tasks. Is that acceptable?
   - Call out any hypocrisy or excuses found in the doc text.

2. **ğŸ“‰ PERFORMANCE ANALYSIS**
   - Rate today's execution (${d.xpRate}x).
   - Analyze his focus: [${d.sessionsArr.join(", ")}]. Are these deep work blocks or fragmented snacks?

3. **âš ï¸ REGRET FORECAST**
   - If he keeps missing task targets like today (${d.tasksDone}/${d.tasksPlanned}), what happens to his rank?
   - Make it visceral.

4. **âœ… TOMORROW'S STRATEGY**
   - Look at "Plan for Next Day" in the doc.
   - Give 3 tactical adjustments to ensure he actually hits 100% task completion.

5. **ğŸ“– HINGLISH CLOSING**
   - Short, brotherly, emotional punch.

â€”
TONE: Brutal but constructive. Use data to back every point.
`;
}

// ğŸŒ GROQ API
function getGroqResponse(prompt) {
  const API_KEY = PropertiesService.getScriptProperties().getProperty("GROQ_API_KEY");
  const url = "https://api.groq.com/openai/v1/chat/completions";
  const payload = {
    model: "openai/gpt-oss-120b",
    messages: [{ role: "system", content: "You are a brutal JEE mentor." }, { role: "user", content: prompt }],
    temperature: 0.85,
    max_tokens: 1500
  };
  try {
    const res = UrlFetchApp.fetch(url, {
      method: "post",
      headers: { "Authorization": "Bearer " + API_KEY, "Content-Type": "application/json" },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
    return JSON.parse(res.getContentText()).choices?.[0]?.message?.content || "âŒ Empty";
  } catch (e) { return "âŒ Error"; }
}

// ğŸ› ï¸ PARSER
function parseMarkdownToHTML(text) {
  if (!text) return "";
  let html = text.replace(/\r\n/g, '\n')
    .replace(/^###\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/^\*\*(.+)\*\*$/gm, '<h2>$1</h2>')
    .replace(/^\d+\.\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/^- (.*)$/gm, '<li>$1</li>')
    .replace(/(<li>.*?<\/li>)/s, '<ul>$1</ul>')
    .replace(/^(?!<h2|<li|<ul)(.+)$/gm, '<p>$1</p>');
  const parts = html.split('<h2>');
  let final = "";
  if (parts[0].trim()) final += `<div class="intro">${parts[0]}</div>`;
  for (let i = 1; i < parts.length; i++) {
    let titleEnd = parts[i].indexOf('</h2>');
    final += `<div class="section"><h2>${parts[i].substring(0, titleEnd)}</h2><div class="content">${parts[i].substring(titleEnd + 5)}</div></div>`;
  }
  return final || `<div class="section"><p>${text}</p></div>`;
}

// ğŸ¨ PREMIUM UI (ULTIMATE VERSION)
function buildStyledHTML(dateStr, aiContent, d) {
  const body = parseMarkdownToHTML(aiContent);
  return `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body { 
    font-family: 'Inter', sans-serif; 
    color: #1a1a1a; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 40px 20px;
  }
  
  .container { 
    max-width: 880px; 
    margin: 0 auto; 
    background: #fff; 
    border-radius: 24px; 
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    overflow: hidden;
  }
  
  /* HEADER - GRADIENT */
  .header { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff; 
    padding: 50px 40px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  .header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: rgba(255,255,255,0.05);
    border-radius: 50%;
  }
  
  .header::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -5%;
    width: 200px;
    height: 200px;
    background: rgba(255,255,255,0.03);
    border-radius: 50%;
  }
  
  h1 { 
    font-family: 'JetBrains Mono'; 
    font-size: 36px; 
    font-weight: 800;
    margin-bottom: 8px; 
    letter-spacing: -1px;
    position: relative;
    z-index: 1;
  }
  
  .subtitle { 
    color: rgba(255,255,255,0.85); 
    font-size: 14px; 
    margin-top: 12px;
    font-weight: 500;
    letter-spacing: 1px;
    text-transform: uppercase;
    position: relative;
    z-index: 1;
  }
  
  /* BADGES */
  .badges { 
    display: flex; 
    justify-content: center; 
    gap: 12px; 
    margin-top: 24px;
    position: relative;
    z-index: 1;
  }
  
  .badge { 
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    padding: 8px 16px; 
    border-radius: 24px; 
    font-size: 13px; 
    font-weight: 700; 
    font-family: 'JetBrains Mono';
    letter-spacing: 0.5px;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  .badge-highlight { 
    background: rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.4);
  }

  /* DASHBOARD */
  .dashboard { 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 16px; 
    padding: 40px;
    background: #f8f9fb;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .metric { 
    background: #fff;
    padding: 24px;
    border-radius: 16px;
    text-align: center;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
  }
  
  .metric:hover { 
    box-shadow: 0 8px 20px rgba(102,126,234,0.1);
    transform: translateY(-4px);
  }
  
  .metric-val { 
    display: block; 
    font-size: 28px; 
    font-weight: 800; 
    color: #1a1a1a;
    font-family: 'JetBrains Mono';
    margin-bottom: 6px;
  }
  
  .metric-lbl { 
    font-size: 11px; 
    text-transform: uppercase; 
    color: #888;
    font-weight: 700;
    letter-spacing: 1.2px;
  }
  
  /* SESSION BAR */
  .session-wrapper { 
    padding: 32px 40px; 
    border-bottom: 1px solid #e5e7eb;
  }
  
  .session-label { 
    font-size: 12px; 
    color: #888; 
    font-weight: 700; 
    margin-bottom: 10px; 
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .session-bar { 
    display: flex; 
    gap: 6px; 
    height: 10px; 
    border-radius: 6px; 
    overflow: hidden; 
    background: #e5e7eb;
  }
  
  .seg { 
    height: 100%; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
    opacity: 0.7;
    transition: opacity 0.3s;
  }
  
  .seg.deep { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    opacity: 1; 
  }

  /* CONTENT */
  .content-area { 
    padding: 40px;
  }
  
  .intro {
    background: #f0f4ff;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
    border-left: 4px solid #667eea;
  }

  .section { 
    background: #fff;
    border: 1px solid #e5e7eb;
    border-left: 5px solid #667eea;
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    page-break-inside: avoid;
  }
  
  .section:nth-of-type(1) { border-left-color: #ef4444; background: linear-gradient(to right, rgba(239,68,68,0.03), transparent); }
  .section:nth-of-type(2) { border-left-color: #f59e0b; background: linear-gradient(to right, rgba(245,158,11,0.03), transparent); }
  .section:nth-of-type(3) { border-left-color: #8b5cf6; background: linear-gradient(to right, rgba(139,92,246,0.03), transparent); }
  .section:nth-of-type(4) { border-left-color: #10b981; background: linear-gradient(to right, rgba(16,185,129,0.03), transparent); }
  .section:nth-of-type(5) { border-left-color: #3b82f6; background: linear-gradient(to right, rgba(59,130,246,0.03), transparent); }

  h2 { 
    margin: 0 0 18px 0; 
    font-size: 17px; 
    text-transform: uppercase; 
    letter-spacing: 1.2px; 
    font-weight: 800;
    color: #1a1a1a;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 12px;
  }
  
  p { 
    line-height: 1.8; 
    margin: 12px 0; 
    font-size: 15px; 
    color: #4b5563;
  }
  
  ul {
    margin: 16px 0;
    padding-left: 24px;
  }
  
  li { 
    margin-bottom: 8px; 
    line-height: 1.7;
    color: #4b5563;
  }
  
  b { 
    color: #1a1a1a; 
    font-weight: 700;
  }

  /* FOOTER */
  .footer { 
    text-align: center; 
    padding: 32px 40px;
    background: linear-gradient(135deg, #f8f9fb 0%, #e5e7eb 100%);
    border-top: 1px solid #e5e7eb;
    color: #888; 
    font-size: 12px; 
    font-family: 'JetBrains Mono';
    letter-spacing: 0.5px;
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>REALITY CHECK</h1>
      <div class="subtitle">Daily Performance Audit</div>
      <div class="badges">
        <span class="badge">ğŸ“Š LEVEL ${d.level}</span>
        <span class="badge badge-highlight">ğŸ”¥ STREAK ${d.streak} DAYS</span>
      </div>
    </div>

    <div class="dashboard">
      <div class="metric">
        <span class="metric-val" style="color: ${d.xpRate >= 1 ? '#10b981' : '#ef4444'}">${d.xpRate}x</span>
        <span class="metric-lbl">XP Rate</span>
      </div>
      <div class="metric">
        <span class="metric-val">${d.studyTimeEarned}m</span>
        <span class="metric-lbl">Study Time</span>
      </div>
      <div class="metric">
        <span class="metric-val">${d.tasksDone}/${d.tasksPlanned}</span>
        <span class="metric-lbl">Tasks Done</span>
      </div>
      <div class="metric">
        <span class="metric-val" style="color: #ef4444">${d.phoneTime}m</span>
        <span class="metric-lbl">Phone Waste</span>
      </div>
    </div>

    <div class="session-wrapper">
      <div class="session-label">ğŸ“ˆ Session Flow: ${d.sessionString}</div>
      <div class="session-bar">
        ${d.sessionsArr.map(m => `<div class="seg ${m>90?'deep':''}" style="width:${(m/10)}%"></div>`).join('')}
      </div>
    </div>

    <div class="content-area">
      ${body}
    </div>

    <div class="footer">
      âœ¨ GENERATED BY NEUBOFY LIFESTYLE SYSTEM DEVLOPED BY PAWAN WASHUDEV â€¢ ${dateStr}
    </div>
  </div>
</body>
</html>`;
}
